---
title: "Heart Disease"
author: "Sander"
date: "9/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(kableExtra)
library(scales)
library(ggcorrplot)
library(reshape2)
```

# Logbook
## EDA
Kaggle direct link to dataset: https://www.kaggle.com/fedesoriano/heart-failure-prediction

### Research question: Is it possible to create an accurate(F/P. <= 20% & F/N <= 10%) machine learning model that predicts the chance of developing heartdisease in a broad spectrum of patients.

Due to the potential damage F/N will cause, it is important to reduce the F/N. Altough there is a balance between F/N and F/P/ A high F/P will cause unnesscary testing and will increase costs, while a high F/N will be potential dangerous as it misses T/P patients.
\newpage


```{r parsedata}
heartdata <- read.table("data/heart.csv", sep=",", header=TRUE)
heartdata$HeartDisease <- as.logical(heartdata$HeartDisease)
```
```{r Summary}
summ <- summary(heartdata[c("Age", "RestingBP", "Cholesterol", "FastingBS", "MaxHR", "Oldpeak")])
tab <- sub('.*:', '', summ)
rownames(tab) <- c("Min", "1st. Qu", "Median", "Mean", "3rd. Qu", "Max")
kable(tab, caption = "5 num of numerical valies") %>% 
  kable_styling(latex_options="scale_down")
```


```{r Ratio male to female}
# counts (or sums of weights)
ggplot(heartdata, aes(Sex)) + 
  geom_bar(fill=hue_pal()(2)) + labs(
  title = "Datapoints per sex",
)  + ylab("Datapoints")

p <- prop.table(table(heartdata$Sex))
```
  
As visible in the barplot, the ratio of female(`r round(p["F"] * 100, 2)`%) to male(`r round(p["M"] * 100, 2)`%) is very skewed towards males.   

### Histogram  
```{r}
ggplot(heartdata, aes(Age, fill=HeartDisease)) + 
  geom_histogram(bins=12) + 
  geom_vline(aes(xintercept=mean(Age[HeartDisease==F]), colour="Mean age without HD"),  size=1, linetype="dashed") + 
  geom_vline(aes(xintercept=mean(Age[HeartDisease==T]), colour="Mean age with HD"),  size=1, linetype="dashed") +
  scale_color_manual(name="Means", values =c("dodgerblue1", "red")) + 
    guides(col = guide_legend(override.aes = list(shape = 15, size=5))) + 
  ggtitle("Histogram of age while also visualising HD")

```
  
As seen in the above graph, we can discover that there seems to be a relation between age increase and an increase in heartdisease. We will explore this further in the underlying graph. When watching the age mean lines it is further seen that the average age of patients with HD is higher then the average patient without HD.  

```{r heartdisease rate per age}
ggplot(heartdata) + 
  geom_smooth(aes(Age, HeartDisease * 100), method="loess", formula = "y ~ x", color=hue_pal()(1), fill = hue_pal()(2)[2]) + 
  ylab("Heart Disease (%)") + 
  ggtitle("Percentage of patients affected by HD by age") + 
  ylim(c(0, 100))
```
  
Using a Smooth line we can see that the percentage of patients with HD increases with age and declines after 65.
The reason for decline might be that patients who have HD above the age of 65 will die earlier then healthy individuals. A short internet search will also confirm that HD is the leading cause of death for people above the age of 65. Underlying image provides further insight. Source: [ec.europa.eu](https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Causes_of_death_statistics_-_people_over_65)   

```{r load image, echo=FALSE}
# Define variable containing url
url <- "https://ec.europa.eu/eurostat/statistics-explained/images/2/25/Major_causes_of_death%2C_EU-27%2C_2016_%28standardised_death_rates_per_100_000_inhabitants%29_Health20.png"
```
<center><img src="`r url`"></center>

  

The graphs below use abreviasions. The meaning of these can be found in this table:  
| Code | Type              | Explanation                                                                                                                                                                                                           |
|------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| TA   | Typical Angina    | Meets all three of the following characteristics: - Substernal chest discomfort of characteristic quality and duration - Provoked by extortion or emotional stress - Relieved by rest and/or nitrates within minutes. |
| ATA  | Atypical Angina   | Meets two of these characteristics                                                                                                                                                                                    |
| NAP  | Non-Anginal Pain  | Lacks or meets only one or none of the characteristics                                                                                                                                                                |
| ASY  | Asymptomatic Pain |                                                                                                                                                                                                                       |  


```{r}
p <- ggplot(heartdata, aes(x=RestingBP, group=ChestPainType, colour=ChestPainType)) + 
  geom_density() + xlab("Resting BP (mm Hg)") + ggtitle("Density plot of RestingBP split by ChestPainType")
p
```
The type of pain an individual experiences doesn't seem to change the blood pressure of the individual.
  
```{r}
p <- ggplot(heartdata, aes(x=Cholesterol, group=ChestPainType, colour=ChestPainType)) + 
  geom_density() + 
  xlab("Cholesterol in serum (mm/dl)") + ggtitle("Density plot of cholesterol in serum split by ChestPainType")
p
```
As visible in the above plot. The type of chestpain doesn't seem to differ based on the concentration of cholesterol in blood.  

```{r}
p <- ggplot(heartdata, aes(x=MaxHR, group=ChestPainType, colour=ChestPainType)) + 
  geom_density() + 
  xlab("Max heartrate") +  ggtitle("Density plot of MaxHR split by ChestPainType")
p
```
There seems to be a small gap in max heartrate with patients ASY (Asymptomatic) vs ATA (Atypical Angina).  

### Age ~ MaxHR grouped by Sex
```{r Age/Sex ~ MaxHR}
ggplot(heartdata, aes(Age, MaxHR, group=Sex, colour = Sex)) + 
  geom_point(alpha=0.15) + geom_smooth(se=F) + ggtitle("Comparing MaxHR with age split by sex")
```
  
As expected MaxHR goes down with age. The female lines doesnt go down as expected, this might be due to the fact there is a smaller amount of data for older females(Age > 55 = `r NROW(subset(heartdata, Sex=="F" & Age > 55))`) in comparison with males (Age > 55 = `r NROW(subset(heartdata, Sex=="M" & Age > 55))`). To further analyse the difference in datapoints per sex, a density plot is made.

```{r}
ggplot(heartdata) + geom_density(aes(Age, colour=Sex, fill=Sex), alpha=0.05) + ggtitle("Density plot comparing sexes")
```

  
### Finding correlation between MaxHR and HD
```{r correlation}
ggplot(heartdata[heartdata$Cholesterol > 0,], aes(x=Age, y=Cholesterol, colour=HeartDisease, shape=ChestPainType)) + 
  geom_point() + 
  ggtitle("Age vs Cholesterol") + 
  geom_abline(color = "dodgerblue1")
```
  
The amount of cholesterol increases slightly with age.

```{r pressure, echo=FALSE}

everysecond <- function(x){
  x <- sort(unique(x))
  x[seq(2, length(x), 2)] <- ""
  x
}


diseased_age <- table(heartdata$Age, heartdata$HeartDisease)
percentage <- as.data.frame.matrix(diseased_age) 
colnames(percentage) <- c("Not-diseased", "Diseased")
percentage$Age <- rownames(percentage)
rownames(percentage) <- c()
percentage$Ratio <-100 / (percentage$`Not-diseased` + percentage$Diseased)  * percentage$Diseased
ggplot(percentage, aes(x=Age, y=Ratio)) + geom_point(aes(Age, Ratio, size = `Not-diseased` + Diseased)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(title = "Heart disease accurance with age", x = "Age (years)", y = "Percentage diseased", size = "Datasamples per age") + scale_x_discrete(labels = everysecond(percentage$Age)) +
  scale_size_continuous(range = c(0, 10))

```